---
title: "Near Analysis - GLS"
author: "JD Stewart (@thecrobe)"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---
```{r Introduction, echo=FALSE}

# The goal of this study is to answer:

#"Are crop yields greater inside or outside the crop's geographic center of origin as a function of escaping pest and pathogen pressure?"

# Reproducibility

#This document can be regenerated using Rmarkdown and the associated R-script (Analyses_Figures.R). This R-script, in combination with the supplementary data files (available online at github.com/thecrobe) also allows for full reproducibility of all the the figures and analyses conducted in R. All other analyses are conducted in ArcMap by ESRI. 
```

```{r Packages, include=TRUE, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE}

#models
library(wPerm)
library(caret)
library(wPerm)
#library(spatialEco)
#library(rgdal)
library(RVAideMemoire)
library(nlme)

#plots
library(RColorBrewer)
library(ggplot2)
library(wesanderson)

#data wrangling
library(reshape2)
library(dplyr)
library(Hmisc)

### Graphics

theme_justin<-theme_bw() +theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())
```


## Near Analysis Models 

<div class = "col-md-4">
<br><br> **What Was Tested:** Do crop yields increase from GCOs globally no matter where you are located, e.g. with randomized GCOs?
</div>

<div class = "col-md-4">
<br><br> **What This Allows Me To Do:** Identify if yield-distance relationships (near analysis) are a function of evolutionary escape or other variables.
</div>

<div class = "col-md-4">
<br><br> **What Are The Model Assumptions:** GLS models are used as they have less assumptions about error structure and heteroscadicity. 
</div>

#Barley -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Barley Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.barley<-subset(fishnet, fishnet$mean_barle > 0 ) #yield > 0 
xy <- coordinates(fishnet.barley)
yield <- fishnet.barley@data

barleyGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="BarleyWheat_GC")

barleyGCOcentroid<-gCentroid(barleyGCO)

library(dplyr)
distances <- spDistsN1(xy,barleyGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
barley.near<-yield %>% dplyr::select(mean_barle,rescale_ND,COUNTRY)
barley.near<-barley.near %>% filter(mean_barle > 0, na.rm=TRUE)
barley.near<-barley.near %>% filter(rescale_ND > 0, na.rm=TRUE)
barley.near$logBarley<-log10(barley.near$mean_barle)

###  Model - Barley 
# regular OLS no variance structure
barley.ols <- gls(logBarley ~ rescale_ND, data = barley.near)
# varFixed (variance changes linearly with X)
barley.fixed <- update(barley.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
barley.power <- update(barley.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
barley.exp <- update(barley.ols, . ~., weights = varExp(form = ~ rescale_ND)) # error
# varConstPower (constant plus a power function of X (useful if X includes 0))
barley.ConstPower <- update(barley.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(barley.ols, barley.fixed, barley.power, barley.ConstPower, barley.exp)
summary(barley.exp)

#Pivot Table To ID Top Producers by Country Sum 
barley.pivot<-dcast(barley.near, COUNTRY ~., value.var="mean_barle", fun.aggregate=sum)
barley.pivot<-arrange(barley.pivot,.)
tail(barley.pivot, 3) #ID Top 3 Producing Countries
barley.top<-tail(barley.pivot, 3)
sum(barley.pivot$.) #Total Production
sum(barley.top$.)/sum(barley.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(barley.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_barle)/sum(barley.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"
summary(china)

usa<-filter(barley.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_barle)/sum(barley.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

russia<-filter(barley.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_barle)/sum(barley.pivot$.) 
print(russia.Perc) # % of Global Fertilizer For Crop 
russia.color<-"#D3867A"

#Plot
ggplot(barley.near, aes(x=rescale_ND, y=logBarley)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_barle)), color        =china.color, alpha=0.9) + 
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_barle)), color        =usa.color, alpha=0.5) + 
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_barle)),        color=russia.color, alpha=0.2) +
  geom_abline(aes(intercept=coef(barley.exp)[1], slope=coef(barley.exp)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```

#Cassava -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Cassava Near near Model, "}

```
#Groundnut -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Groundnut Near near Model, "}

```
#Maize -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Maize Near near Model, "}

```
#Potato -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Millet Near near Model, "}

```
#Rapeseed -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Rapeseed Near near Model, "}

```
#Rice -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Rice Near near Model, "}

```
#Rye -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Rye Near near Model, "}

```
#Sorghum -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Sorghum Near near Model, "}

```
#Soybean -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Soybean Near near Model, "}

```

#Sunflower -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Sunflower Near near Model, "}

```
#Wheat -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Wheat Near near Model, "}

```

