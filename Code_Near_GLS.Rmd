---
title: "Near Analysis - GLS"
author: "JD Stewart (@thecrobe)"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---
```{r Introduction, echo=FALSE}

# The goal of this study is to answer:

#"Are crop yields greater inside or outside the crop's geographic center of origin as a function of escaping pest and pathogen pressure?"

# Reproducibility

#This document can be regenerated using Rmarkdown and the associated R-script (Analyses_Figures.R). This R-script, in combination with the supplementary data files (available online at github.com/thecrobe) also allows for full reproducibility of all the the figures and analyses conducted in R. All other analyses are conducted in ArcMap by ESRI. 
```

```{r Packages, include=TRUE, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE}

#models
library(wPerm)
library(caret)
library(wPerm)
#library(spatialEco)
#library(rgdal)
library(RVAideMemoire)
library(nlme)

#plots
library(RColorBrewer)
library(ggplot2)
library(wesanderson)

#data wrangling
library(reshape2)
library(dplyr)
library(Hmisc)

### Graphics

theme_justin<-theme_bw() +theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())
```


## Near Analysis Models 

<div class = "col-md-4">
<br><br> **What Was Tested:** Do crop yields increase from GCOs globally no matter where you are located, e.g. with randomized GCOs?
</div>

<div class = "col-md-4">
<br><br> **What This Allows Me To Do:** Identify if yield-distance relationships (near analysis) are a function of evolutionary escape or other variables.
</div>

<div class = "col-md-4">
<br><br> **What Are The Model Assumptions:** GLS models are used as they have less assumptions about error structure and heteroscadicity. 
</div>

#Barley -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Barley Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.barley<-subset(fishnet, fishnet$mean_barle > 0 ) #yield > 0 
xy <- coordinates(fishnet.barley)
yield <- fishnet.barley@data

barleyGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="BarleyWheat_GC")

barleyGCOcentroid<-gCentroid(barleyGCO)

library(dplyr)
distances <- spDistsN1(xy,barleyGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
barley.near<-yield %>% dplyr::select(mean_barle,rescale_ND,COUNTRY)
barley.near<-barley.near %>% filter(mean_barle > 0, na.rm=TRUE)
barley.near<-barley.near %>% filter(rescale_ND > 0, na.rm=TRUE)
barley.near$logBarley<-log10(barley.near$mean_barle)

###  Model - Barley 
# regular OLS no variance structure
barley.ols <- gls(logBarley ~ rescale_ND, data = barley.near)
# varFixed (variance changes linearly with X)
barley.fixed <- update(barley.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
barley.power <- update(barley.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
barley.exp <- update(barley.ols, . ~., weights = varExp(form = ~ rescale_ND)) # error
# varConstPower (constant plus a power function of X (useful if X includes 0))
barley.ConstPower <- update(barley.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(barley.ols, barley.fixed, barley.power, barley.ConstPower, barley.exp)
summary(barley.exp)

#Pivot Table To ID Top Producers by Country Sum 
barley.pivot<-dcast(barley.near, COUNTRY ~., value.var="mean_barle", fun.aggregate=sum)
barley.pivot<-arrange(barley.pivot,.)
tail(barley.pivot, 3) #ID Top 3 Producing Countries
barley.top<-tail(barley.pivot, 3)
sum(barley.pivot$.) #Total Production
sum(barley.top$.)/sum(barley.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(barley.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_barle)/sum(barley.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"
summary(china)

usa<-filter(barley.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_barle)/sum(barley.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

russia<-filter(barley.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_barle)/sum(barley.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"

#Plot
ggplot(barley.near, aes(x=rescale_ND, y=logBarley)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_barle)), color        =china.color, alpha=0.9) + 
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_barle)), color        =usa.color, alpha=0.5) + 
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_barle)),        color=russia.color, alpha=0.2) +
  geom_abline(aes(intercept=coef(barley.exp)[1], slope=coef(barley.exp)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```

#Cassava -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Cassava Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.cassava<-subset(fishnet, fishnet$mean_cassa > 0 ) #yield > 0 
xy <- coordinates(fishnet.cassava)
yield <- fishnet.cassava@data

cassavaGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Cassava_GC")

cassavaGCOcentroid<-gCentroid(cassavaGCO)

library(dplyr)
distances <- spDistsN1(xy,cassavaGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
cassava.near<-yield %>% dplyr::select(mean_cassa,rescale_ND,COUNTRY)
cassava.near<-cassava.near %>% filter(mean_cassa > 0, na.rm=TRUE)
cassava.near<-cassava.near %>% filter(rescale_ND > 0, na.rm=TRUE)
cassava.near$logcassava<-log10(cassava.near$mean_cassa)

###  Model - cassava 
# regular OLS no variance structure
cassava.ols <- gls(logcassava ~ rescale_ND, data = cassava.near)
# varFixed (variance changes linearly with X)
cassava.fixed <- update(cassava.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
cassava.power <- update(cassava.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
cassava.exp <- update(cassava.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
cassava.ConstPower <- update(cassava.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(cassava.ols, cassava.fixed, cassava.power, cassava.ConstPower, cassava.exp)
summary(cassava.exp)

#Pivot Table To ID Top Producers by Country Sum 
cassava.pivot<-dcast(cassava.near, COUNTRY ~., value.var="mean_cassa", fun.aggregate=sum)
cassava.pivot<-arrange(cassava.pivot,.)
tail(cassava.pivot, 3) #ID Top 3 Producing Countries
cassava.top<-tail(cassava.pivot, 3)
sum(cassava.pivot$.) #Total Production
sum(cassava.top$.)/sum(cassava.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(cassava.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_cassa)/sum(cassava.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"
summary(china)

brazil<-filter(cassava.near, COUNTRY == "Brazil")
brazil.Perc<-sum(brazil$mean_cassa)/sum(cassava.pivot$.) 
print(brazil.Perc) # % of Global Production For Crop 
brazil.color<-"#E28D15"

indo<-filter(cassava.near, COUNTRY == "Indonesia")
indo.Perc<-sum(indo$mean_cassa)/sum(cassava.pivot$.) 
print(indo.Perc) # % of Global Production For Crop 
indo.color<-"#63377C"

#Plot
ggplot(cassava.near, aes(x=rescale_ND, y=logcassava)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_cassa)), color        =china.color, alpha=0.5) + 
  geom_point(data=brazil, aes(x=rescale_ND, y=log10(brazil$mean_cassa)),        color=brazil.color, alpha=0.5) + 
  geom_point(data=indo, aes(x=rescale_ND, y=log10(indo$mean_cassa)),        color=indo.color, alpha=0.8) +
  geom_abline(aes(intercept=coef(cassava.exp)[1], slope=coef(cassava.exp)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")


```
#Groundnut -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Groundnut Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.groundnut<-subset(fishnet, fishnet$mean_groun > 0 ) #yield > 0 
xy <- coordinates(fishnet.groundnut)
yield <- fishnet.groundnut@data

groundnutGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Groundnut_GC")

groundnutGCOcentroid<-gCentroid(groundnutGCO)

library(dplyr)
distances <- spDistsN1(xy,groundnutGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
groundnut.near<-yield %>% dplyr::select(mean_groun,rescale_ND,COUNTRY)
groundnut.near<-groundnut.near %>% filter(mean_groun > 0, na.rm=TRUE)
groundnut.near<-groundnut.near %>% filter(rescale_ND > 0, na.rm=TRUE)
groundnut.near$loggroundnut<-log10(groundnut.near$mean_groun)

###  Model - groundnut 
# regular OLS no variance structure
groundnut.ols <- gls(loggroundnut ~ rescale_ND, data = groundnut.near)
# varFixed (variance changes linearly with X)
groundnut.fixed <- update(groundnut.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
groundnut.power <- update(groundnut.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
groundnut.exp <- update(groundnut.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
groundnut.ConstPower <- update(groundnut.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(groundnut.ols, groundnut.fixed, groundnut.power, groundnut.ConstPower, groundnut.exp)
summary(groundnut.exp)

#Pivot Table To ID Top Producers by Country Sum 
groundnut.pivot<-dcast(groundnut.near, COUNTRY ~., value.var="mean_groun", fun.aggregate=sum)
groundnut.pivot<-arrange(groundnut.pivot,.)
tail(groundnut.pivot, 3) #ID Top 3 Producing Countries
groundnut.top<-tail(groundnut.pivot, 3)
sum(groundnut.pivot$.) #Total Production
sum(groundnut.top$.)/sum(groundnut.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(groundnut.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_groun)/sum(groundnut.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"
summary(china)

indo<-filter(groundnut.near, COUNTRY == "Indonesia")
indo.Perc<-sum(indo$mean_groun)/sum(groundnut.pivot$.) 
print(indo.Perc) # % of Global Production For Crop 
indo.color<-"#63377C"

india<-filter(groundnut.near, COUNTRY == "India")
india.Perc<-sum(india$mean_groun)/sum(groundnut.pivot$.) 
print(india.Perc) # % of Global Production For Crop 
india.color<-"#078D40"

#Plot
ggplot(groundnut.near, aes(x=rescale_ND, y=loggroundnut)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_groun)), color        =china.color, alpha=0.5) + 
  geom_point(data=indo, aes(x=rescale_ND, y=log10(indo$mean_groun)),                color=indo.color, alpha=0.8) +
  geom_point(data=india, aes(x=rescale_ND, y=log10(india$mean_groun)),           color=india.color, alpha=0.5) + 
  geom_abline(aes(intercept=coef(groundnut.exp)[1], slope=coef(groundnut.exp)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```
#Maize -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Maize Near near Model, "}
fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.maize<-subset(fishnet, fishnet$mean_maize > 0 ) #yield > 0 
xy <- coordinates(fishnet.maize)
yield <- fishnet.maize@data

maizeGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Maize_GC")

maizeGCOcentroid<-gCentroid(maizeGCO)

library(dplyr)
distances <- spDistsN1(xy,maizeGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
maize.near<-yield %>% dplyr::select(mean_maize,rescale_ND,COUNTRY)
maize.near<-maize.near %>% filter(mean_maize > 0, na.rm=TRUE)
maize.near<-maize.near %>% filter(rescale_ND > 0, na.rm=TRUE)
maize.near$logmaize<-log10(maize.near$mean_maize)

###  Model - maize 
# regular OLS no variance structure
maize.ols <- gls(logmaize ~ rescale_ND, data = maize.near)
# varFixed (variance changes linearly with X)
maize.fixed <- update(maize.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
maize.power <- update(maize.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
maize.exp <- update(maize.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
maize.ConstPower <- update(maize.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(maize.ols, maize.fixed, maize.power, maize.ConstPower, maize.exp)
summary(maize.exp)

#Pivot Table To ID Top Producers by Country Sum 
maize.pivot<-dcast(maize.near, COUNTRY ~., value.var="mean_maize", fun.aggregate=sum)
maize.pivot<-arrange(maize.pivot,.)
tail(maize.pivot, 3) #ID Top 3 Producing Countries
maize.top<-tail(maize.pivot, 3)
sum(maize.pivot$.) #Total Production
sum(maize.top$.)/sum(maize.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(maize.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_maize)/sum(maize.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"
summary(china)

usa<-filter(maize.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_maize)/sum(maize.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

russia<-filter(maize.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_maize)/sum(maize.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"


#Plot
ggplot(maize.near, aes(x=rescale_ND, y=logmaize)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_maize)), color        =usa.color, alpha=0.8) + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_maize)),                color=china.color, alpha=0.5) +
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_maize)),           color=russia.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(maize.exp)[1], slope=coef(maize.exp)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```
#Potato -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Millet Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.potat<-subset(fishnet, fishnet$mean_potat > 0 ) #yield > 0 
xy <- coordinates(fishnet.potat)
yield <- fishnet.potat@data

potatGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Potato")

potatGCOcentroid<-gCentroid(potatGCO)

library(dplyr)
distances <- spDistsN1(xy,potatGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
potat.near<-yield %>% dplyr::select(mean_potat,rescale_ND,COUNTRY)
potat.near<-potat.near %>% filter(mean_potat > 0, na.rm=TRUE)
potat.near<-potat.near %>% filter(rescale_ND > 0, na.rm=TRUE)
potat.near$logpotat<-log10(potat.near$mean_potat)

###  Model - potat 
# regular OLS no variance structure
potat.ols <- gls(logpotat ~ rescale_ND, data = potat.near)
# varFixed (variance changes linearly with X)
potat.fixed <- update(potat.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
potat.power <- update(potat.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
potat.exp <- update(potat.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
potat.ConstPower <- update(potat.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(potat.ols, potat.fixed, potat.power, potat.exp, potat.ConstPower)
summary(potat.ConstPower)

#Pivot Table To ID Top Producers by Country Sum 
potat.pivot<-dcast(potat.near, COUNTRY ~., value.var="mean_potat", fun.aggregate=sum)
potat.pivot<-arrange(potat.pivot,.)
tail(potat.pivot, 3) #ID Top 3 Producing Countries
potat.top<-tail(potat.pivot, 3)
sum(potat.pivot$.) #Total Production
sum(potat.top$.)/sum(potat.pivot$.) # % produced by top 3 

#Filter Countries

usa<-filter(potat.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_potat)/sum(potat.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

china<-filter(potat.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_potat)/sum(potat.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

canada<-filter(potat.near, COUNTRY == "Canada") 
canada.Perc<-sum(canada$mean_potat)/sum(potato.pivot$.) 
print(canada.Perc) # % of Global Production For Crop 
canada.color<-"#98C24B"


#Plot
ggplot(potat.near, aes(x=rescale_ND, y=logpotat)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_potat)),                color=china.color, alpha=0.8) +
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_potat)),           color=usa.color, alpha=0.4) + 
  geom_point(data=canada, aes(x=rescale_ND, y=log10(canada$mean_potat)), color=canada.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(potat.ConstPower)[1], slope=coef(potat.ConstPower)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")


```
#Rapeseed -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Rapeseed Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.rapes<-subset(fishnet, fishnet$mean_rapes > 0 ) #yield > 0 
xy <- coordinates(fishnet.rapes)
yield <- fishnet.rapes@data

rapesGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Rapeseed")

rapesGCOcentroid<-gCentroid(rapesGCO)

library(dplyr)
distances <- spDistsN1(xy,rapesGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
rapes.near<-yield %>% dplyr::select(mean_rapes,rescale_ND,COUNTRY)
rapes.near<-rapes.near %>% filter(mean_rapes > 0, na.rm=TRUE)
rapes.near<-rapes.near %>% filter(rescale_ND > 0, na.rm=TRUE)
rapes.near$lograpes<-log10(rapes.near$mean_rapes)

###  Model - rapes 
# regular OLS no variance structure
rapes.ols <- gls(lograpes ~ rescale_ND, data = rapes.near)
# varFixed (variance changes linearly with X)
rapes.fixed <- update(rapes.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
rapes.power <- update(rapes.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
#rapes.exp <- update(rapes.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
rapes.ConstPower <- update(rapes.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(rapes.ols, rapes.fixed, rapes.power, rapes.ConstPower)
summary(rapes.power)

#Pivot Table To ID Top Producers by Country Sum 
rapes.pivot<-dcast(rapes.near, COUNTRY ~., value.var="mean_rapes", fun.aggregate=sum)
rapes.pivot<-arrange(rapes.pivot,.)
tail(rapes.pivot, 3) #ID Top 3 Producing Countries
rapes.top<-tail(rapes.pivot, 3)
sum(rapes.pivot$.) #Total Production
sum(rapes.top$.)/sum(rapes.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(rapes.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_rapes)/sum(rapes.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

brazil<-filter(rapes.near, COUNTRY == "Brazil")
brazil.Perc<-sum(brazil$mean_rapes)/sum(rapes.pivot$.) 
print(brazil.Perc) # % of Global Production For Crop 
brazil.color<-"#E28D15"

russia<-filter(rapes.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_rapes)/sum(rapes.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"


#Plot
ggplot(rapes.near, aes(x=rescale_ND, y=lograpes)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_rapes)),                color=china.color, alpha=0.5) +
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_rapes)),           color=russia.color, alpha=0.3) + 
  geom_point(data=brazil, aes(x=rescale_ND, y=log10(brazil$mean_rapes)), color        =brazil.color, alpha=0.8) + 
  geom_abline(aes(intercept=coef(rapes.power)[1], slope=coef(rapes.power)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```
#Rice -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Rice Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.Rice<-subset(fishnet, fishnet$mean_rice_ > 0 ) #yield > 0 
xy <- coordinates(fishnet.Rice)
yield <- fishnet.Rice@data

RiceGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Rice_GC1")

RiceGCOcentroid<-gCentroid(RiceGCO)

library(dplyr)
distances <- spDistsN1(xy,RiceGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
Rice.near<-yield %>% dplyr::select(mean_rice_,rescale_ND,COUNTRY)
Rice.near<-Rice.near %>% filter(mean_rice_ > 0, na.rm=TRUE)
Rice.near<-Rice.near %>% filter(rescale_ND > 0, na.rm=TRUE)
Rice.near$logRice<-log10(Rice.near$mean_rice_)

###  Model - Rice 
# regular OLS no variance structure
Rice.ols <- gls(logRice ~ rescale_ND, data = Rice.near)
# varFixed (variance changes linearly with X)
Rice.fixed <- update(Rice.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
Rice.power <- update(Rice.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
Rice.exp <- update(Rice.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
Rice.ConstPower <- update(Rice.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(Rice.ols, Rice.fixed, Rice.power, Rice.exp, Rice.ConstPower)
summary(Rice.power)

#Pivot Table To ID Top Producers by Country Sum 
Rice.pivot<-dcast(Rice.near, COUNTRY ~., value.var="mean_rice_", fun.aggregate=sum)
Rice.pivot<-arrange(Rice.pivot,.)
tail(Rice.pivot, 3) #ID Top 3 Producing Countries
Rice.top<-tail(Rice.pivot, 3)
sum(Rice.pivot$.) #Total Production
sum(Rice.top$.)/sum(Rice.pivot$.) # % produced by top 3 

#Filter Countries
china<-filter(Rice.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_Rice)/sum(Rice.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

brazil<-filter(Rice.near, COUNTRY == "Brazil")
brazil.Perc<-sum(brazil$mean_Rice)/sum(Rice.pivot$.) 
print(brazil.Perc) # % of Global Production For Crop 
brazil.color<-"#E28D15"

india<-filter(data, COUNTRY == "India")
india.Perc<-sum(india$wheat_Fert)/sum(wheat.pivot$.) 
print(india.Perc) # % of Global Production For Crop 
india.color<-"#078D40"


#Plot
ggplot(Rice.near, aes(x=rescale_ND, y=logRice)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_rice_)),                color=china.color, alpha=0.5) +
  geom_point(data=brazil, aes(x=rescale_ND, y=log10(brazil$mean_rice_)), color=brazil.color, alpha=0.8) + 
  geom_point(data=india, aes(x=rescale_ND, y=log10(india$mean_rice_)),           color=russia.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(Rice.power)[1], slope=coef(Rice.power)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")


```
#Rye -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Rye Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.rye<-subset(fishnet, fishnet$mean_rye_YY > 0 ) #yield > 0 
xy <- coordinates(fishnet.rye)
yield <- fishnet.rye@data

ryeGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Rye")

ryeGCOcentroid<-gCentroid(ryeGCO)

library(dplyr)
distances <- spDistsN1(xy,ryeGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
rye.near<-yield %>% dplyr::select(mean_rye_Y,rescale_ND,COUNTRY)
rye.near<-rye.near %>% filter(mean_rye_Y > 0, na.rm=TRUE)
rye.near<-rye.near %>% filter(rescale_ND > 0, na.rm=TRUE)
rye.near$logrye<-log10(rye.near$mean_rye_Y)

###  Model - rye 
# regular OLS no variance structure
rye.ols <- gls(logrye ~ rescale_ND, data = rye.near)
# varFixed (variance changes linearly with X)
rye.fixed <- update(rye.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
rye.power <- update(rye.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
rye.exp <- update(rye.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
rye.ConstPower <- update(rye.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(rye.ols, rye.fixed, rye.power, rye.exp, rye.ConstPower)
summary(rye.ConstPower)

#Pivot Table To ID Top Producers by Country Sum 
rye.pivot<-dcast(rye.near, COUNTRY ~., value.var="mean_rye_Y", fun.aggregate=sum)
rye.pivot<-arrange(rye.pivot,.)
tail(rye.pivot, 3) #ID Top 3 Producing Countries
rye.top<-tail(rye.pivot, 3)
sum(rye.pivot$.) #Total Production
sum(rye.top$.)/sum(rye.pivot$.) # % produced by top 3 

#Filter Countries

russia<-filter(rye.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_rye_Y)/sum(rye.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"

china<-filter(rye.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_rye)/sum(rye.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

usa<-filter(rye.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_rye_Y)/sum(rye.pivot$.) 
print(usa.Perc) # % of Global Fertilizer For Crop 
usa.color<-"#8F4A33"


#Plot
ggplot(rye.near, aes(x=rescale_ND, y=logrye)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_rye_Y)), color=russia.color, alpha=0.8) + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_rye_Y)),                color=china.color, alpha=0.8) +
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_rye_Y)),           color=usa.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(rye.ConstPower)[1], slope=coef(rye.ConstPower)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")


```
#Sorghum -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Sorghum Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.sorghum<-subset(fishnet, fishnet$mean_sorgh > 0 ) #yield > 0 
xy <- coordinates(fishnet.sorghum)
yield <- fishnet.sorghum@data

sorghumGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Sorghum_GC")

sorghumGCOcentroid<-gCentroid(sorghumGCO)

library(dplyr)
distances <- spDistsN1(xy,sorghumGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
sorghum.near<-yield %>% dplyr::select(mean_sorgh,rescale_ND,COUNTRY)
sorghum.near<-sorghum.near %>% filter(mean_sorgh > 0, na.rm=TRUE)
sorghum.near<-sorghum.near %>% filter(rescale_ND > 0, na.rm=TRUE)
sorghum.near$logsorghum<-log10(sorghum.near$mean_sorgh)

###  Model - sorghum 
# regular OLS no variance structure
sorghum.ols <- gls(logsorghum ~ rescale_ND, data = sorghum.near)
# varFixed (variance changes linearly with X)
sorghum.fixed <- update(sorghum.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
sorghum.power <- update(sorghum.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
sorghum.exp <- update(sorghum.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
sorghum.ConstPower <- update(sorghum.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(sorghum.ols, sorghum.fixed, sorghum.power, sorghum.exp, sorghum.ConstPower)
summary(sorghum.exp)

#Pivot Table To ID Top Producers by Country Sum 
sorghum.pivot<-dcast(sorghum.near, COUNTRY ~., value.var="mean_sorgh", fun.aggregate=sum)
sorghum.pivot<-arrange(sorghum.pivot,.)
tail(sorghum.pivot, 3) #ID Top 3 Producing Countries
sorghum.top<-tail(sorghum.pivot, 3)
sum(sorghum.pivot$.) #Total Production
sum(sorghum.top$.)/sum(sorghum.pivot$.) # % produced by top 3 

#Filter Countries

china<-filter(sorghum.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_sorgh)/sum(sorghum.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

usa<-filter(sorghum.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_sorgh)/sum(sorghum.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

russia<-filter(sorghum.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_sorgh)/sum(sorghum.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"


#Plot
ggplot(sorghum.near, aes(x=rescale_ND, y=logsorghum)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_sorgh)),                color=china.color, alpha=0.8) +
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_sorgh)),           color=usa.color, alpha=0.5) + 
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_sorgh)), color=russia.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(sorghum.ConstPower)[1], slope=coef(sorghum.ConstPower)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```
#Soybean -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Soybean Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.soybe<-subset(fishnet, fishnet$mean_soybe > 0 ) #yield > 0 
xy <- coordinates(fishnet.soybe)
yield <- fishnet.soybe@data

soybeGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Soy_Millet")

soybeGCOcentroid<-gCentroid(soybeGCO)

library(dplyr)
distances <- spDistsN1(xy,soybeGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
soybe.near<-yield %>% dplyr::select(mean_soybe,rescale_ND,COUNTRY)
soybe.near<-soybe.near %>% filter(mean_soybe > 0, na.rm=TRUE)
soybe.near<-soybe.near %>% filter(rescale_ND > 0, na.rm=TRUE)
soybe.near$logsoybe<-log10(soybe.near$mean_soybe)

###  Model - soybe 
# regular OLS no variance structure
soybe.ols <- gls(logsoybe ~ rescale_ND, data = soybe.near)
# varFixed (variance changes linearly with X)
soybe.fixed <- update(soybe.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
soybe.power <- update(soybe.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
soybe.exp <- update(soybe.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
soybe.ConstPower <- update(soybe.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(soybe.ols, soybe.fixed, soybe.power, soybe.exp, soybe.ConstPower)
summary(soybe.ConstPower)

#Pivot Table To ID Top Producers by Country Sum 
soybe.pivot<-dcast(soybe.near, COUNTRY ~., value.var="mean_soybe", fun.aggregate=sum)
soybe.pivot<-arrange(soybe.pivot,.)
tail(soybe.pivot, 3) #ID Top 3 Producing Countries
soybe.top<-tail(soybe.pivot, 3)
sum(soybe.pivot$.) #Total Production
sum(soybe.top$.)/sum(soybe.pivot$.) # % produced by top 3 

#Filter Countries

china<-filter(soybe.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_soybe)/sum(soybe.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

usa<-filter(soybe.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_soybe)/sum(soybe.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

russia<-filter(soybe.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_soybe)/sum(soybe.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"


#Plot
ggplot(soybe.near, aes(x=rescale_ND, y=logsoybe)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_soybe)),                color=china.color, alpha=0.8) +
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_soybe)),           color=usa.color, alpha=0.3) + 
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_soybe)), color=russia.color, alpha=0.1) + 
  geom_abline(aes(intercept=coef(soybe.ConstPower)[1], slope=coef(soybe.ConstPower)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")


```

#Sunflower -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Sunflower Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.sunflower<-subset(fishnet, fishnet$mean_sunfl > 0 ) #yield > 0 
xy <- coordinates(fishnet.sunflower)
yield <- fishnet.sunflower@data

sunflowerGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="Sunflower_GC")

sunflowerGCOcentroid<-gCentroid(sunflowerGCO)

library(dplyr)
distances <- spDistsN1(xy,sunflowerGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
sunflower.near<-yield %>% dplyr::select(mean_sunfl,rescale_ND,COUNTRY)
sunflower.near<-sunflower.near %>% filter(mean_sunfl > 0, na.rm=TRUE)
sunflower.near<-sunflower.near %>% filter(rescale_ND > 0, na.rm=TRUE)
sunflower.near$logsunflower<-log10(sunflower.near$mean_sunfl)

###  Model - sunflower 
# regular OLS no variance structure
sunflower.ols <- gls(logsunflower ~ rescale_ND, data = sunflower.near)
# varFixed (variance changes linearly with X)
sunflower.fixed <- update(sunflower.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
sunflower.power <- update(sunflower.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
sunflower.exp <- update(sunflower.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
sunflower.ConstPower <- update(sunflower.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(sunflower.ols, sunflower.fixed, sunflower.power, sunflower.exp, sunflower.ConstPower)
summary(sunflower.ConstPower)

#Pivot Table To ID Top Producers by Country Sum 
sunflower.pivot<-dcast(sunflower.near, COUNTRY ~., value.var="mean_sunfl", fun.aggregate=sum)
sunflower.pivot<-arrange(sunflower.pivot,.)
tail(sunflower.pivot, 3) #ID Top 3 Producing Countries
sunflower.top<-tail(sunflower.pivot, 3)
sum(sunflower.pivot$.) #Total Production
sum(sunflower.top$.)/sum(sunflower.pivot$.) # % produced by top 3 

#Filter Countries

usa<-filter(sunflower.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_sunfl)/sum(sunflower.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

china<-filter(sunflower.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_sunfl)/sum(sunflower.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

brazil<-filter(sunflower.near, COUNTRY == "Brazil")
brazil.Perc<-sum(brazil$mean_sunfle)/sum(cassava.pivot$.) 
print(brazil.Perc) # % of Global Production For Crop 
brazil.color<-"#E28D15"


#Plot
ggplot(sunflower.near, aes(x=rescale_ND, y=logsunflower)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_sunfl)),                color=china.color, alpha=0.8) +
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_sunfl)),           color=usa.color, alpha=0.4) + 
  geom_point(data=brazil, aes(x=rescale_ND, y=log10(brazil$mean_sunfl)), color=brazil.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(sunflower.ConstPower)[1], slope=coef(sunflower.ConstPower)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")

```
#Wheat -
```{r, message=TRUE, warning=FALSE, cache=TRUE, fig.cap="Wheat Near near Model, "}

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fishnet.wheat<-subset(fishnet, fishnet$mean_wheat > 0 ) #yield > 0 
xy <- coordinates(fishnet.wheat)
yield <- fishnet.wheat@data

wheatGCO<-readOGR(dsn = "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/GCO_Shapefiles/",layer="BarleyWheat_GC")

wheatGCOcentroid<-gCentroid(wheatGCO)

library(dplyr)
distances <- spDistsN1(xy,wheatGCOcentroid, longlat = FALSE)
yield$rescale_ND<-distances/(1000*1000)
wheat.near<-yield %>% dplyr::select(mean_wheat,rescale_ND,COUNTRY)
wheat.near<-wheat.near %>% filter(mean_wheat > 0, na.rm=TRUE)
wheat.near<-wheat.near %>% filter(rescale_ND > 0, na.rm=TRUE)
wheat.near$logwheat<-log10(wheat.near$mean_wheat)

###  Model - wheat 
# regular OLS no variance structure
wheat.ols <- gls(logwheat ~ rescale_ND, data = wheat.near)
# varFixed (variance changes linearly with X)
wheat.fixed <- update(wheat.ols, .~., weights = varFixed(~rescale_ND))
# varPower (variance changes as a power function with X)
wheat.power <- update(wheat.ols, . ~ ., weights = varPower(form = ~rescale_ND))
# varExp (variance changes as an exponential function of x)
wheat.exp <- update(wheat.ols, . ~., weights = varExp(form = ~ rescale_ND)) 
# varConstPower (constant plus a power function of X (useful if X includes 0))
wheat.ConstPower <- update(wheat.ols, . ~., weights = varConstPower(form = ~ rescale_ND))
# compare all models by AIC
AIC(wheat.ols, wheat.fixed, wheat.power, wheat.exp, wheat.ConstPower)
summary(wheat.exp)

#Pivot Table To ID Top Producers by Country Sum 
wheat.pivot<-dcast(wheat.near, COUNTRY ~., value.var="mean_wheat", fun.aggregate=sum)
wheat.pivot<-arrange(wheat.pivot,.)
tail(wheat.pivot, 3) #ID Top 3 Producing Countries
wheat.top<-tail(wheat.pivot, 3)
sum(wheat.pivot$.) #Total Production
sum(wheat.top$.)/sum(wheat.pivot$.) # % produced by top 3 

#Filter Countries

usa<-filter(wheat.near, COUNTRY == "United States")
usa.Perc<-sum(usa$mean_wheat)/sum(wheat.pivot$.) 
print(usa.Perc) # % of Global Production For Crop 
usa.color<-"#8F4A33"

china<-filter(wheat.near, COUNTRY == "China") 
china.Perc<-sum(china$mean_wheat)/sum(wheat.pivot$.) 
print(china.Perc) # % of Global Production For Crop 
china.color<-"#1665AF"

russia<-filter(wheat.near, COUNTRY == "Russian Federation")
russia.Perc<-sum(russia$mean_wheat)/sum(wheat.pivot$.) 
print(russia.Perc) # % of Global Production For Crop 
russia.color<-"#D3867A"


#Plot
ggplot(wheat.near, aes(x=rescale_ND, y=logwheat)) +
  geom_point(alpha=0.3) +theme_justin + 
  geom_point(data=china, aes(x=rescale_ND, y=log10(china$mean_wheat)),                color=china.color, alpha=0.8) +
  geom_point(data=usa, aes(x=rescale_ND, y=log10(usa$mean_wheat)),           color=usa.color, alpha=0.4) + 
  geom_point(data=russia, aes(x=rescale_ND, y=log10(russia$mean_wheat)), color=russia.color, alpha=0.3) + 
  geom_abline(aes(intercept=coef(wheat.exp)[1], slope=coef(wheat.exp)[2]), color="red", size=2) +labs(color='GCO') +theme_justin +xlab("Distance From GCO (1000's km)") +ylab ("Log10 Yield")


```

