---
title: "Near Analysis Low Fertilizer Removed"
author: "JD Stewart"
date: "2/22/2021"
output: html_document
---

```{r Introduction, echo=FALSE}

# This document contains code for identifying the relationship between spatial distance and crop yields  to determine the extent GCO escape effects are driven by spatial processes. 

# Reproducibility

#This document can be regenerated using Rmarkdown and the associated R-script (Analyses_Figures.R). This R-script, in combination with the supplementary data files (available online at github.com/thecrobe) also allows for full reproducibility of all the the figures and analyses conducted in R. All other analyses are conducted in A`rcMap by ESRI. 
```

# Near Analysis Models 

<div class = "col-md-4">
<br><br> **What Was Tested:** Do crop yields increase from GCOs globally as a function of distance when high fertilizer countries are removed? Note that high fertilizer countries were identified as the top 3 applications of N + P + K bt sum. 
</div>

<div class = "col-md-4">
<br><br> **What This Allows Me To Do:** Identify if yield-distance relationships (near analysis) are a function of evolutionary escape or other fertilizer.
</div>

<div class = "col-md-4">
<br><br> **What Are The Model Assumptions:** GLS models are used as they have less assumptions about error structure and heteroscadicity. 
</div>

```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
library(rgdal)
library(maptools)
library(rgeos)
library(ggplot2)
library(dplyr)
library(reshape2)
library(nlme)

#ggplot graphic parameters
theme_justin<-theme_bw() +theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())

```

#Barley
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fertilizer<-read.csv(file="Fertilizer_Near/Near_Fertilizer_Fishnet.csv", header=T) #import fert
fishnet.m <- na.omit(merge(fishnet, fertilizer, by='Fishnet_ID'))#merge 
fishnet.low<-subset(fishnet.m, fishnet.m$barley_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_barle > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$barley_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.barley<-subset(fishnet.m, fishnet.m$barley_FertMean < 18.98) #subset below 50% of data


### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.barley)
metadata <- fishnet.low.barley@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_barley<-distances/(1000*1000)
  barley.near.low<-metadata %>% select(mean_barle,rescale_ND_barley)
  barley.near.low<-barley.near.low %>% filter(mean_barle > 0, na.rm=TRUE)
  barley.near.low<-barley.near.low %>% filter(rescale_ND_barley > 0, na.rm=TRUE)
  barley.near.low$logBarley<-log10(barley.near.low$mean_barle)
  
  # fit yield ~ distance model
  barley.low.gls <- gls(logBarley ~ rescale_ND_barley, data = barley.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(barley.low.gls)[2], xy[random.point,], summary(barley.low.ols)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=output.low$x, y=y, color=slope)) +geom_point
```

#Sorghum
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fertilizer<-read.csv(file="Fertilizer_Near/Near_Fertilizer_Fishnet.csv", header=T) #import fert
fishnet.m <- na.omit(merge(fishnet, fertilizer, by='Fishnet_ID'))#merge 
fishnet.low<-subset(fishnet.m, fishnet.m$sorghum_FertMean> 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_sorgh > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$sorghum_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.sorghum<-subset(fishnet.m, fishnet.m$sorghum_FertMean < 5.035) #subset below 25% of data

summary(fishnet.low$mean_sorgh)

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.sorghum)
metadata <- fishnet.low.sorghum@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_sorghum<-distances/(1000*1000)
  sorghum.near.low<-metadata %>% select(mean_sorgh,rescale_ND_sorghum)
  sorghum.near.low<-sorghum.near.low %>% filter(mean_sorgh > 0, na.rm=TRUE)
  sorghum.near.low<-sorghum.near.low %>% filter(rescale_ND_sorghum > 0,   
                                                na.rm=TRUE)
  sorghum.near.low$logSorghum<-log10(sorghum.near.low$mean_sorgh)
  
  # fit yield ~ distance model
  sorghum.low.gls <- gls(logSorghum ~ rescale_ND_sorghum, data = sorghum.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(sorghum.low.gls)[2], xy[random.point,], summary(sorghum.low.gls)$tTable[2,4] )
  
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=$x, y=y, color=slope)) +geom_point()

write.csv(output.low,file="Low_Fert_Analyses/RandomGCOs/sorghum_low25percNull.csv")
```

