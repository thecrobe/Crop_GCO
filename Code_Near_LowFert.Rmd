---
title: "Near Analysis Low Fertilizer Removed"
author: "JD Stewart"
date: "2/22/2021"
output: html_document
---

```{r Introduction, echo=FALSE}

# This document contains code for identifying the relationship between spatial distance and crop yields  to determine the extent GCO escape effects are driven by spatial processes. 

# Reproducibility

#This document can be regenerated using Rmarkdown and the associated R-script (Analyses_Figures.R). This R-script, in combination with the supplementary data files (available online at github.com/thecrobe) also allows for full reproducibility of all the the figures and analyses conducted in R. All other analyses are conducted in A`rcMap by ESRI. 
```

# Near Analysis Models 

<div class = "col-md-4">
<br><br> **What Was Tested:** Do crop yields increase from GCOs globally as a function of distance when high fertilizer countries are removed? Note that high fertilizer countries were identified as the top 3 applications of N + P + K bt sum. 
</div>

<div class = "col-md-4">
<br><br> **What This Allows Me To Do:** Identify if yield-distance relationships (near analysis) are a function of evolutionary escape or other fertilizer.
</div>

<div class = "col-md-4">
<br><br> **What Are The Model Assumptions:** GLS models are used as they have less assumptions about error structure and heteroscadicity. 
</div>

```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
library(rgdal)
library(maptools)
library(rgeos)
library(ggplot2)
library(dplyr)
library(reshape2)
library(nlme)

#ggplot graphic parameters
theme_justin<-theme_bw() +theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())

fishnet<- readOGR(dsn= "/Users/justinstewart/Dropbox/Collaborations/TobyKiers/Crop_Productivity_GCO/Analysis/GIS/Fishnet/", layer="Fishnet_yield_NoAntarctica")
fertilizer<-read.csv(file="Fertilizer_Near/Near_Fertilizer_Fishnet.csv", header=T) #import fert
fishnet.m <- na.omit(merge(fishnet, fertilizer, by='Fishnet_ID'))#merge 
```

#Barley
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$barley_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_barle > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$barley_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.barley<-subset(fishnet.m, fishnet.m$barley_FertMean < 18.98) #subset below 50% of data


### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.barley)
metadata <- fishnet.low.barley@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_barley<-distances/(1000*1000)
  barley.near.low<-metadata %>% select(mean_barle,rescale_ND_barley)
  barley.near.low<-barley.near.low %>% filter(mean_barle > 0, na.rm=TRUE)
  barley.near.low<-barley.near.low %>% filter(rescale_ND_barley > 0, na.rm=TRUE)
  barley.near.low$logBarley<-log10(barley.near.low$mean_barle)
  
  # fit yield ~ distance model
  barley.low.gls <- gls(logBarley ~ rescale_ND_barley, data = barley.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(barley.low.gls)[2], xy[random.point,], summary(barley.low.ols)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=output.low$x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert_Analyses/RandomGCOs/barley_low50percNull.csv")
```

#Cassava
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$cassava_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_cassa > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$cassava_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.cassava<-subset(fishnet.m, fishnet.m$cassava_FertMean < 16.82) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.cassava)
metadata <- fishnet.low.cassava@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_cassava<-distances/(1000*1000)
  cassava.near.low<-metadata %>% select(mean_cassa,rescale_ND_cassava)
  cassava.near.low<-cassava.near.low %>% filter(mean_cassa > 0, na.rm=TRUE)
  cassava.near.low<-cassava.near.low %>% filter(rescale_ND_cassava > 0, na.rm=TRUE)
  cassava.near.low$logCassava<-log10(cassava.near.low$mean_cassa)
  
  # fit yield ~ distance model
  cassava.low.gls <- gls(logCassava ~ rescale_ND_cassava, data = cassava.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(cassava.low.gls)[2], xy[random.point,],    summary(cassava.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert_Analyses/RandomGCOs/cassva_low50percNull.csv")
```


#Groundnut
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$groundnut_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_groun > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$groundnut_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.groundnut<-subset(fishnet.m, fishnet.m$groundnut_FertMean < 9.85) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.groundnut)
metadata <- fishnet.low.groundnut@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_groundnut<-distances/(1000*1000)
  groundnut.near.low<-metadata %>% select(mean_groun,rescale_ND_groundnut)
  groundnut.near.low<-groundnut.near.low %>% filter(mean_groun > 0, na.rm=TRUE)
  groundnut.near.low<-groundnut.near.low %>% filter(rescale_ND_groundnut > 0, na.rm=TRUE)
  groundnut.near.low$logGroundnut<-log10(groundnut.near.low$mean_groun)
  
  # fit yield ~ distance model
  groundnut.low.gls <- gls(logGroundnut ~ rescale_ND_groundnut, data = groundnut.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(groundnut.low.gls)[2], xy[random.point,],    summary(groundnut.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert_Analyses/RandomGCOs/groundnut_low50percNull.csv")
```

#Maize
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$maize_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_maize > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$maize_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.maize<-subset(fishnet.m, fishnet.m$maize_FertMean < 20.94) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.maize)
metadata <- fishnet.low.maize@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_maize<-distances/(1000*1000)
  maize.near.low<-metadata %>% select(mean_maize,rescale_ND_maize)
  maize.near.low<-maize.near.low %>% filter(mean_maize > 0, na.rm=TRUE)
  maize.near.low<-maize.near.low %>% filter(rescale_ND_maize > 0, na.rm=TRUE)
  maize.near.low$logMaize<-log10(maize.near.low$mean_maize)
  
  # fit yield ~ distance model
  maize.low.gls <- gls(logMaize ~ rescale_ND_maize, data = maize.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(maize.low.gls)[2], xy[random.point,],    summary(maize.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert_Analyses/RandomGCOs/maize_low50percNull.csv")
```

#Millet
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$millet_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_mille > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$millet_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.millet<-subset(fishnet.m, fishnet.m$millet_FertMean < 10.84) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.millet)
metadata <- fishnet.low.millet@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_millet<-distances/(1000*1000)
  millet.near.low<-metadata %>% select(mean_mille,rescale_ND_millet)
  millet.near.low<-millet.near.low %>% filter(mean_mille > 0, na.rm=TRUE)
  millet.near.low<-millet.near.low %>% filter(rescale_ND_millet > 0, na.rm=TRUE)
  millet.near.low$logMillet<-log10(millet.near.low$mean_mille)
  
  # fit yield ~ distance model
  millet.low.gls <- gls(logMillet ~ rescale_ND_millet, data = millet.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(millet.low.gls)[2], xy[random.point,],    summary(millet.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output,lw,file="Low_Fert/millet_low50percNull.csv")
```

#Rapeseed
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$rapeseed_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_rapes > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$rapeseed_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.rapeseed<-subset(fishnet.m, fishnet.m$rapeseed_FertMean < 26.45) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.rapeseed)
metadata <- fishnet.low.rapeseed@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_rapeseed<-distances/(1000*1000)
  rapeseed.near.low<-metadata %>% select(mean_rapes,rescale_ND_rapeseed)
  rapeseed.near.low<-rapeseed.near.low %>% filter(mean_rapes > 0, na.rm=TRUE)
  rapeseed.near.low<-rapeseed.near.low %>% filter(rescale_ND_rapeseed > 0, na.rm=TRUE)
  rapeseed.near.low$logRapeseed<-log10(rapeseed.near.low$mean_rapes)
  
  # fit yield ~ distance model
  rapeseed.low.gls <- gls(logRapeseed ~ rescale_ND_rapeseed, data = rapeseed.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(rapeseed.low.gls)[2], xy[random.point,],    summary(rapeseed.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/rapeseed_low50percNull.csv")
```

#Rice
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$rice_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_rice_ > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$rice_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.rice<-subset(fishnet.m, fishnet.m$rice_FertMean < 19.76) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.rice)
metadata <- fishnet.low.rice@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_rice<-distances/(1000*1000)
  rice.near.low<-metadata %>% select(mean_rice_,rescale_ND_rice)
  rice.near.low<-rice.near.low %>% filter(mean_rice_ > 0, na.rm=TRUE)
  rice.near.low<-rice.near.low %>% filter(rescale_ND_rice > 0, na.rm=TRUE)
  rice.near.low$logRice<-log10(rice.near.low$mean_rice_)
  
  # fit yield ~ distance model
  rice.low.gls <- gls(logRice ~ rescale_ND_rice, data = rice.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(rice.low.gls)[2], xy[random.point,],    summary(rice.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/rice_low50percNull.csv")
```

#Rye
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$rye_FertMean > 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_rye_Y > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$rye_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.rye<-subset(fishnet.m, fishnet.m$rye_FertMean < 16.04) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.rye)
metadata <- fishnet.low.rye@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_rye<-distances/(1000*1000)
  rye.near.low<-metadata %>% select(mean_groun,rescale_ND_rye)
  rye.near.low<-rye.near.low %>% filter(mean_groun > 0, na.rm=TRUE)
  rye.near.low<-rye.near.low %>% filter(rescale_ND_rye > 0, na.rm=TRUE)
  rye.near.low$logRye<-log10(rye.near.low$mean_groun)
  
  # fit yield ~ distance model
  rye.low.gls <- gls(logRye ~ rescale_ND_rye, data = rye.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(rye.low.gls)[2], xy[random.point,],    summary(rye.low.gls)$tTable[2,4] )
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/rye_low50percNull.csv")
```

#Sorghum
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$sorghum_FertMean> 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_sorgh > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$sorghum_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.sorghum<-subset(fishnet.m, fishnet.m$sorghum_FertMean < 9.59) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.sorghum)
metadata <- fishnet.low.sorghum@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_sorghum<-distances/(1000*1000)
  sorghum.near.low<-metadata %>% select(mean_sorgh,rescale_ND_sorghum)
  sorghum.near.low<-sorghum.near.low %>% filter(mean_sorgh > 0, na.rm=TRUE)
  sorghum.near.low<-sorghum.near.low %>% filter(rescale_ND_sorghum > 0,   
                                                na.rm=TRUE)
  sorghum.near.low$logSorghum<-log10(sorghum.near.low$mean_sorgh)
  
  # fit yield ~ distance model
  sorghum.low.gls <- gls(logSorghum ~ rescale_ND_sorghum, data = sorghum.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(sorghum.low.gls)[2], xy[random.point,], summary(sorghum.low.gls)$tTable[2,4] )
  
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/sorghum_low50percNull.csv")
```

#Soybean
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$soybean_FertMean> 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_soybe > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$soybean_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.soybean<-subset(fishnet.m, fishnet.m$soybean_FertMean < 8.91) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.soybean)
metadata <- fishnet.low.soybean@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_soybean<-distances/(1000*1000)
  soybean.near.low<-metadata %>% select(mean_soybe,rescale_ND_soybean)
  soybean.near.low<-soybean.near.low %>% filter(mean_soybe > 0, na.rm=TRUE)
  soybean.near.low<-soybean.near.low %>% filter(rescale_ND_soybean > 0,   
                                                na.rm=TRUE)
  soybean.near.low$logSoybean<-log10(soybean.near.low$mean_soybe)
  
  # fit yield ~ distance model
  soybean.low.gls <- gls(logSoybean ~ rescale_ND_soybean, data = soybean.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(soybean.low.gls)[2], xy[random.point,], summary(soybean.low.gls)$tTable[2,4] )
  
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/soybean_low50percNull.csv")
```

#Sunflower
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$sunflower_FertMean> 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_sunfl > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$sunflower_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.sunflower<-subset(fishnet.m, fishnet.m$sunflower_FertMean < 6.28) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.sunflower)
metadata <- fishnet.low.sunflower@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_sunflower<-distances/(1000*1000)
  sunflower.near.low<-metadata %>% select(mean_sunfl,rescale_ND_sunflower)
  sunflower.near.low<-sunflower.near.low %>% filter(mean_sunfl > 0, na.rm=TRUE)
  sunflower.near.low<-sunflower.near.low %>% filter(rescale_ND_sunflower > 0,   
                                                na.rm=TRUE)
  sunflower.near.low$logSunflower<-log10(sunflower.near.low$mean_sunfl)
  
  # fit yield ~ distance model
  sunflower.low.gls <- gls(logSunflower ~ rescale_ND_sunflower, data = sunflower.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(sunflower.low.gls)[2], xy[random.point,], summary(sunflower.low.gls)$tTable[2,4] )
  
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/sunflower_low50percNull.csv")
```

#Wheat
```{r,  message=TRUE, warning=FALSE, cache=TRUE, message=FALSE,echo=FALSE}
#### readins and preprocess ######################
fishnet.low<-subset(fishnet.m, fishnet.m$wheat_FertMean> 0 ) #fert > 0 
fishnet.low<-subset(fishnet.m, fishnet.m$mean_wheat > 0 ) # yield > 0 
dim(fishnet) - dim(fishnet.low) # pixels left
quantile(fishnet.low$wheat_FertMean,na.rm = TRUE) #identify quantiles
fishnet.low.wheat<-subset(fishnet.m, fishnet.m$wheat_FertMean < 21.38) #subset below 50% of data

### Get Lat-Long Baby Girl 
xy <- coordinates(fishnet.low.wheat)
metadata <- fishnet.low.wheat@data

# the loop

N <-10000
output.low <- data.frame(slope=numeric(N), x = numeric(N), y = numeric(N), P=numeric(N))
for(i in 1:N){
  # pick a point
  random.point <- sample(1:nrow(xy), 1)
  # calculate distances from that point
  distances <- spDistsN1(xy,xy[random.point,], longlat = FALSE)
  metadata$rescale_ND_wheat<-distances/(1000*1000)
  wheat.near.low<-metadata %>% select(mean_wheat,rescale_ND_wheat)
  wheat.near.low<-wheat.near.low %>% filter(mean_wheat > 0, na.rm=TRUE)
  wheat.near.low<-wheat.near.low %>% filter(rescale_ND_wheat > 0,   
                                                na.rm=TRUE)
  wheat.near.low$logWheat<-log10(wheat.near.low$mean_wheat)
  
  # fit yield ~ distance model
  wheat.low.gls <- gls(logWheat ~ rescale_ND_wheat, data = wheat.near.low)
  
  # associate it to the point
  output.low[i,] <- c(coef(wheat.low.gls)[2], xy[random.point,], summary(wheat.low.gls)$tTable[2,4] )
  
}

#Map 
output.low<-output.low %>% filter (output.low$P < 0.05) #remove insig p values
ggplot(output.low, aes(x=x, y=y, color=slope)) +geom_point()

#write.csv(output.low,file="Low_Fert/wheat_low50percNull.csv")
```



