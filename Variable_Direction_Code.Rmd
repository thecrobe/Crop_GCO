
## Variable Direction Estimation

<div class = "col-md-4">
<br><br> **What Was Tested:** How do crop yields increase or decrease with each single explantory variable in the RFR models? 
</div>

<div class = "col-md-4">
<br><br> **What This Allows Me To Do:** Identify how the emergent correlations from RFR are driven by individual variables. 
</div>

<div class = "col-md-4">
<br><br> **What Are The Model Assumptions:** Permutational Spearman rank-order correlations are used as they will identify monotonic relationships.Permutational tests were chosen as they have few assumptions about the distribution and independence of the data (i.e. exchangability is th only assumption however there is no way to test for this as we do not know the true distribution). Likewise permutational tests destroy the spatial-autocorrelation structure that influences test results. Plots are solely visual.
</div>
---
title: "Variable Direction"
author: "JD Stewart (@thecrobe)"
output:
  html_document: default
  pdf_document: default
editor_options:
  chunk_output_type: inline
---
```{r Introduction, echo=FALSE}

# The goal of this study is to answer:

#"Are crop yields greater inside or outside the crop's geographic center of origin as a function of escaping pest and pathogen pressure?"

# Reproducibility

#This document can be regenerated using Rmarkdown and the associated R-script (Analyses_Figures.R). This R-script, in combination with the supplementary data files (available online at github.com/thecrobe) also allows for full reproducibility of all the the figures and analyses conducted in R. All other analyses are conducted in ArcMap by ESRI. 
```

```{r Packages, include=TRUE, echo=FALSE, message=FALSE, eval=TRUE, warning=FALSE}

#models
library(wPerm)
library(caret)
library(wPerm)
#library(spatialEco)
#library(rgdal)
library(RVAideMemoire)
library(nlme)

#plots
library(RColorBrewer)
library(ggplot2)
library(wesanderson)
library(viridis)
library(viridisLite)

#data wrangling
library(reshape2)
library(dplyr)
library(Hmisc)

### Graphics

theme_justin<-theme_bw() +theme(axis.line = element_line(colour = "black"),
        panel.grid.major = element_blank(),
        panel.grid.minor = element_blank(),
        panel.border = element_blank(),
        panel.background = element_blank())
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}

## Barley
rf.barley<-read.csv(file="Models/Barley_RF.csv", header = T, row.names = 1)
rf.barley<-na.omit(rf.barley)
rf.barley<-log10(rf.barley+1)

#AET
barley.aet<-cor.test(rf.barley$barley_HgHa,rf.barley$AET_mean,method = "pearson") 
print(barley.aet)

#GDP
barley.gdp<-cor.test(rf.barley$barley_HgHa,rf.barley$GDP_Mean,method = "pearson") 
print(barley.gdp)

#Pest
barley.pest<-cor.test(rf.barley$barley_HgHa,rf.barley$Pesticide,method = "pearson") 
print(barley.pest)

#Fertilizer
barley.fert<-cor.test(rf.barley$barley_HgHa,rf.barley$Barley_Fertilizer,method = "pearson") 
print(barley.fert)

```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Cassava
rf.cassava<-read.csv(file="Models/Cassava_RF.csv", header = T, row.names = 1)
rf.cassava$Growing_Mean<-as.numeric(rf.cassava$Growing_Mean)
rf.cassava<-na.omit(rf.cassava)
rf.cassava<-log10(rf.cassava+1)

#AET
cassava.aet<-cor.test(rf.cassava$cassava_HgHa,rf.cassava$AET_mean,method = "pearson") 
print(cassava.aet)

#GDP
cassava.gdp<-cor.test(rf.cassava$cassava_HgHa,rf.cassava$GDP_Mean,method = "pearson") 
print(cassava.gdp)

#Pest
cassava.pest<-cor.test(rf.cassava$cassava_HgHa,rf.cassava$Pesticide,method = "pearson") 
print(cassava.pest)

#Fertilizer
cassava.fert<-cor.test(rf.cassava$cassava_HgHa,rf.cassava$cassava_Fertilizer,method = "pearson")
print(cassava.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Groundnut
rf.groundnut<-read.csv(file="Models/Groundnut_RF.csv", header = T, row.names = 1)
rf.groundnut$Growing_Mean<-as.numeric(rf.groundnut$Growing_Mean)
rf.groundnut<-na.omit(rf.groundnut)
rf.groundnut<-log10(rf.groundnut+1)

#AET
groundnut.aet<-cor.test(rf.groundnut$groundnut_HgHa,rf.groundnut$AET_mean,method = "pearson") 
print(groundnut.aet)

#GDP
groundnut.gdp<-cor.test(rf.groundnut$groundnut_HgHa,rf.groundnut$GDP_Mean,method = "pearson") 
print(groundnut.gdp)

#Pest
groundnut.pest<-cor.test(rf.groundnut$groundnut_HgHa,rf.groundnut$Pesticide,method = "pearson") 
print(groundnut.pest)

#Fertilizer
groundnut.fert<-cor.test(rf.groundnut$groundnut_HgHa,rf.groundnut$groundnut_Fertilizer,method = "pearson")
print(groundnut.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Maize
rf.maize<-read.csv(file="Models/Maize_RF.csv", header = T, row.names = 1)
rf.maize$Growing_Mean<-as.numeric(rf.maize$Growing_Mean)
rf.maize<-na.omit(rf.maize)
rf.maize<-log10(rf.maize+1)

#AET
maize.aet<-cor.test(rf.maize$maize_HgHa,rf.maize$AET_mean,method = "pearson") 
print(maize.aet)

#GDP
maize.gdp<-cor.test(rf.maize$maize_HgHa,rf.maize$GDP_Mean,method = "pearson") 
print(maize.gdp)

#Pest
maize.pest<-cor.test(rf.maize$maize_HgHa,rf.maize$Pesticide,method = "pearson") 
print(maize.pest)

#Fertilizer
maize.fert<-cor.test(rf.maize$maize_HgHa,rf.maize$maize_Fertilizer,method = "pearson")
print(maize.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Potato

rf.Potato<-read.csv(file="Models/Potato_RF.csv", header = T, row.names = 1)
rf.Potato<-na.omit(rf.Potato)
rf.Potato<-log10(rf.Potato+1)

#AET
Potato.aet<-cor.test(rf.Potato$mean_potat,rf.Potato$AET_mean,method = "pearson") 
print(Potato.aet)

#GDP
Potato.gdp<-cor.test(rf.Potato$mean_potat,rf.Potato$GDP_Mean,method = "pearson") 
print(Potato.gdp)

#Pest
Potato.pest<-cor.test(rf.Potato$mean_potat,rf.Potato$Pesticide,method = "pearson") 
print(Potato.pest)

#Fertilizer
Potato.fert<-cor.test(rf.Potato$mean_potat,rf.Potato$Potato_Fe,method = "pearson")
print(Potato.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Rapeseed
rf.rapeseed<-read.csv(file="Models/Rapeseed_RF.csv", header = T, row.names = 1)
rf.rapeseed<-na.omit(rf.rapeseed)
rf.rapeseed<-log10(rf.rapeseed+1)

#AET
rapeseed.aet<-cor.test(rf.rapeseed$rapeseed_HgHa,rf.rapeseed$AET_mean,method = "pearson") 
print(rapeseed.aet)

#GDP
rapeseed.gdp<-cor.test(rf.rapeseed$rapeseed_HgHa,rf.rapeseed$GDP_Mean,method = "pearson") 
print(rapeseed.gdp)

#Pest
rapeseed.pest<-cor.test(rf.rapeseed$rapeseed_HgHa,rf.rapeseed$Pesticide,method = "pearson") 
print(rapeseed.pest)

#Fertilizer
rapeseed.fert<-cor.test(rf.rapeseed$rapeseed_HgHa,rf.rapeseed$rapeseed_Fertilizer,method = "pearson")
print(rapeseed.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Rice
rf.rice<-read.csv(file="Models/Rice_RF.csv", header = T, row.names = 1)
rf.rice<-na.omit(rf.rice)
rf.rice<-log10(rf.rice+1)

#AET
rice.aet<-cor.test(rf.rice$rice_HgHa,rf.rice$AET_mean,method = "pearson") 
print(rice.aet)

#GDP
rice.gdp<-cor.test(rf.rice$rice_HgHa,rf.rice$GDP_Mean,method = "pearson") 
print(rice.gdp)

#Pest
rice.pest<-cor.test(rf.rice$rice_HgHa,rf.rice$Pesticide,method = "pearson") 
print(rice.pest)

#Fertilizer
rice.fert<-cor.test(rf.rice$rice_HgHa,rf.rice$rice_Fertilizer,method = "pearson")
print(rice.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Rye
rf.rye<-read.csv(file="Models/Rye_RF.csv", header = T, row.names = 1)
rf.rye<-na.omit(rf.rye)
rf.rye<-log10(rf.rye+1)

#AET
rye.aet<-cor.test(rf.rye$rye_HgHa,rf.rye$AET_mean,method = "pearson") 
print(rye.aet)

#GDP
rye.gdp<-cor.test(rf.rye$rye_HgHa,rf.rye$GDP_Mean,method = "pearson") 
print(rye.gdp)

#Pest
rye.pest<-cor.test(rf.rye$rye_HgHa,rf.rye$Pesticide,method = "pearson") 
print(rye.pest)

#Fertilizer
rye.fert<-cor.test(rf.rye$rye_HgHa,rf.rye$rye_Fertilizer,method = "pearson")
print(rye.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}

##Sorghum
rf.sorghum<-read.csv(file="Models/Sorghum_RF.csv", header = T, row.names = 1)
rf.sorghum<-na.omit(rf.sorghum)
rf.sorghum<-log10(rf.sorghum+1)

#AET
sorghum.aet<-cor.test(rf.sorghum$Yield,rf.sorghum$Evapotranspiraton,method = "pearson") 
print(sorghum.aet)

#GDP
sorghum.gdp<-cor.test(rf.sorghum$Yield,rf.sorghum$GDP,method = "pearson") 
#print(sorghum.gdp)

#Pest
sorghum.pest<-cor.test(rf.sorghum$Yield,rf.sorghum$Pesticide,method = "pearson") 
print(sorghum.pest)

#Fertilizer
sorghum.fert<-cor.test(rf.sorghum$Yield,rf.sorghum$sorghum_Fertilizer,method = "pearson")
print(sorghum.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Soybean
rf.soybean<-read.csv(file="Models/Soybean_RF.csv", header = T, row.names = 1)
rf.soybean<-na.omit(rf.soybean)
rf.soybean<-log10(rf.soybean+1)

#AET
soybean.aet<-cor.test(rf.soybean$soybean_HgHa,rf.soybean$AET_mean,method = "pearson") 
print(soybean.aet)

#GDP
soybean.gdp<-cor.test(rf.soybean$soybean_HgHa,rf.soybean$GDP_Mean,method = "pearson") 
print(soybean.gdp)

#Pest
soybean.pest<-cor.test(rf.soybean$soybean_HgHa,rf.soybean$Pesticide,method = "pearson") 
print(soybean.pest)

#Fertilizer
soybean.fert<-cor.test(rf.soybean$soybean_HgHa,rf.soybean$soybean_Fertilizer,method = "pearson")
print(soybean.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Sunflower
rf.sunflower<-read.csv(file="Models/Sunflower_RF.csv", header = T, row.names = 1)
rf.sunflower<-na.omit(rf.sunflower)
rf.sunflower<-log10(rf.sunflower+1)

#AET
sunflower.aet<-cor.test(rf.sunflower$sunflower_HgHa,rf.sunflower$AET_mean,method = "pearson") 
print(sunflower.aet)

#GDP
sunflower.gdp<-cor.test(rf.sunflower$sunflower_HgHa,rf.sunflower$GDP_Mean,method = "pearson")
print(sunflower.gdp)

#Pest
sunflower.pest<-cor.test(rf.sunflower$sunflower_HgHa,rf.sunflower$Pesticide,method = "pearson") 
print(sunflower.pest)

#Fertilizer
sunflower.fert<-cor.test(rf.sunflower$sunflower_HgHa,rf.sunflower$sunflower_Fertilizer,method = "pearson")
print(sunflower.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
##Wheat
rf.wheat<-read.csv(file="Models/Wheat_RF.csv", header = T, row.names = 1)
rf.wheat<-na.omit(rf.wheat)
rf.wheat<-log10(rf.wheat+1)

#AET
wheat.aet<-cor.test(rf.wheat$wheat_HgHa,rf.wheat$AET_mean,method = "pearson") 
print(wheat.aet)

#GDP
wheat.gdp<-cor.test(rf.wheat$wheat_HgHa,rf.wheat$GDP_Mean,method = "pearson") 
print(wheat.gdp)

#Pest
wheat.pest<-cor.test(rf.wheat$wheat_HgHa,rf.wheat$Pesticide,method = "pearson")
print(wheat.pest)

#Fertilizer
wheat.fert<-cor.test(rf.wheat$wheat_HgHa,rf.wheat$wheat_Fertilizer,method = "pearson")
print(wheat.fert)
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
# Tabulate in Excel and then import
vard<-read.csv(file="Models/VariableDirection/VariableDirection.csv", header=T)

vard$Crop<-factor(vard$Crop, levels=vard$Crop) #set factor
vard.m<-melt(vard) #melt

#heatmap
library(reshape2)
ggplot(vard.m, aes(x=vard.m$variable, y=vard.m$Crop, fill=vard.m$value)) + 
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0))  + 
  coord_equal() +xlab("Variable") +ylab("Crop")  +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ scale_fill_viridis(option = "D") 
```

```{r Variable Direction Estimation,fig.align='center',message=FALSE, warning=FALSE, cache=TRUE}
# VarImportance
varimp<-read.csv(file="Models/VariableDirection/VariableIMP_Pivot_Graph.csv", header=T)

vi.m<-melt(varimp)

ggplot(vi.m, aes(x=vard.m$variable, y=vard.m$Crop, fill=vard.m$value)) + 
  geom_tile() + 
  scale_fill_gradientn(colours = pal) + 
  scale_x_discrete(expand = c(0, 0)) +
  scale_y_discrete(expand = c(0, 0))  + 
  coord_equal() +xlab("Variable") +ylab("Crop")  +
  theme(axis.text.x = element_text(angle = 90, vjust = 0.5, hjust=1))+ scale_fill_viridis(option = "B") 

```
